<!DOCTYPE html>
<html lang="en-us">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>
Setting up my HomeServer - Part 3 | Arunmozhi
</title>

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">

<meta name="generator" content="Hugo 0.154.5">


<link rel="canonical" href="http://localhost:1313/2022/12/05/setting-up-my-homeserver-part-3/" >




<link href="/css/style.min.66302fa6c122ab7804faa4bd6465554ac4d746c25294af622826d0445b79ab94.css" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
<link rel="stylesheet" href="/css/custom.css">



</head>

<body>

    <div class="flexWrapper">
        <header class="headerWrapper">
    <div class="header">
        <div>
            <a class="terminal" href="/">
                <span>Arunmozhi@arunmozhi.in ~ $</span>
            </a>
        </div>
        <input class="side-menu" type="checkbox" id="side-menu">
        <label class="hamb" for="side-menu"><span class="hamb-line"></span></label>
        <nav class="headerLinks">
            <ul>
                
                <li>
                    <a href="http://localhost:1313/posts/" title="" >
                        ~/blog</a>
                </li>
                
                <li>
                    <a href="http://localhost:1313/about/" title="" >
                        ~/about</a>
                </li>
                
            </ul>
        </nav>
    </div>
</header>


        <div class="content">
            <main class="main">
                
<div class="postWrapper">
        <h1>Setting up my HomeServer - Part 3</h1>
        

    
    
    
    

    
    
    
    
    

    
    
    
    
    

    
    
    
    

    
    
    
    

    
    
    
    

    
    <section class="postMetadata">
        <dl>
            
                
<dt>tags</dt>
<dd><span></span>
    <a href="/tags/homeserver/">#Homeserver</a><span></span>
    <a href="/tags/internet/">#Internet</a><span></span>
    <a href="/tags/technology/">#Technology</a></dd>
            
            
            
                
<dt>categories</dt>
<dd><span></span>
    <a href="/categories/projects/">Projects</a></dd>
            
            
                <dt>published</dt>
                 
                 
                 <dd><time datetime="2022-12-05">2022-12-05</time></dd>
            
            
                <dt>reading time</dt>
                <dd>5 minutes</dd>
            
        </dl>
    </section>
    
        <div>
            <p>I have so far written about:</p>
<ul>
<li>
<p>
<a href="https://arunmozhi.in/2022/11/24/setting-up-my-homeserver-part-1/" target="_blank" rel="noopener">the hardware and the OS</a>
 and</p>
</li>
<li>
<p>how I 
<a href="https://arunmozhi.in/2022/11/26/setting-up-my-homeserver-part-2/" target="_blank" rel="noopener">handle the networking</a>
</p>
</li>
</ul>
<p>and this post is about how I use 
<a href="https://www.nomadproject.io/" target="_blank" rel="noopener">Nomad</a>
 to deploy software.</p>
<h3 id="but-before-that">But before that&hellip;</h3>
<p>I have some updates in the networking department. I had mentioned in Part 2 that, I use Nginx as a reverse proxy to route traffic from the internet into my public apps like Misskey.</p>
<p>By picking up the cues from 
<a href="https://captnemo.in/blog/2018/04/22/home-server-networking/" target="_blank" rel="noopener">Nemo&rsquo;s setup</a>
, I experimented with 
<a href="https://traefik.io/traefik/" target="_blank" rel="noopener">Traefik</a>
 and replace Nginx with Traefik. It was made easier by the fact that 
<a href="https://traefik.io/blog/traefik-proxy-fully-integrates-with-hashicorp-nomad/" target="_blank" rel="noopener">Traefik fully supports Nomad service discovery</a>
. That means, I don&rsquo;t have to run something like Consul just to handle the service to Traefik Proxy mapping.</p>
<h3 id="running-traefik">Running Traefik</h3>
<p>I was running Nginx as a Systemd service in the OCI virtual machine and Nomad was limited to running services in my Intel NUC. While moving to Traefik, I configured the OCI VM as a Nomad client and attached it to the Nomad &ldquo;Cluster&rdquo;. Since Nomad is running on the Tailscale network, I didn&rsquo;t have to fiddle with any of the networking/firewall stuff in the OCI VM, making the setup simple.</p>
<p><img src="/img/wp-content/uploads/2022/12/homeserver-routing.png?w=911" alt=""></p>
<p>Traefik is run as a Docker container in the VM with the &ldquo;host&rdquo; network mode so that it listens to the VM ports 80/443, which are open to the outside internet. I have specifically mapped the Traefik dashboard to the &ldquo;tailscale&rdquo; network, allowing me to access the dashboard via SSH tunneling without have to have the 8080 port open to the rest of the world.</p>
<pre tabindex="0"><code>// Nomad configuration

    network {
      port  &#34;http&#34; {
        static = 80
      }
      port &#34;https&#34; {
        static = 443
      }

      port &#34;admin&#34; {
        static = 8080
        host_network = &#34;tailscale&#34;
      }
    }

    task &#34;server&#34; {
      driver = &#34;docker&#34;
      config {
        image = &#34;traefik:2.9&#34;
        ports = [&#34;admin&#34;, &#34;http&#34;, &#34;https&#34;]
        network_mode = &#34;host&#34;
        volumes = [
          &#34;local/traefik.toml:/etc/traefik/traefik.toml&#34;,
          &#34;local/ssl/cert.pem:/etc/ssl/cert.pem&#34;,
          &#34;local/ssl/private.key:/etc/ssl/private.key&#34;,
        ]
      }
    }
</code></pre><h2 id="deploying-applications">Deploying Applications</h2>
<p>All the services are written as Nomad Job specifications, with a specific network config, and service definition. Then I deploy the software from my laptop to my homeserver by running Terraform.</p>
<p>Ideally, I should be creating the Oracle VM using Terraform as well. But the entire journey has been a series of trail and error experiments, that I haven&rsquo;t done that. I think I will migrate to a Terrform defined/created VM once I figure out how to get Nomad installed and setup without manually SSHing into the VM.</p>
<h3 id="typical-setup-workflow">Typical Setup Workflow</h3>
<p><img src="/img/wp-content/uploads/2022/12/workflow.png?w=1024" alt=""></p>
<p>Since, most of what we are dealing with are web services, I haven&rsquo;t run into a situation where I had to deal with a non-docker deployment yet. But I rest easy knowing that when the day comes, I can rely on the &ldquo;exec&rdquo; and &ldquo;raw_exec&rdquo; drivers of Nomad to run them using pretty much the same workflow.</p>
<h3 id="dealing-with-secrets">Dealing with Secrets</h3>
<p>One of the biggest concerns about all of this is dealing with secrets like, DB credentials, API Keys, ..etc., For example, how do I supply the DB Username and Password to the Nomad Job running my application without storing them in the Job configuration files which I have on version control?</p>
<p>There are many ways to do it, from defining them as Terraform variables and storing it as git-ignored file withing the repo to deploying 
<a href="https://www.vaultproject.io/" target="_blank" rel="noopener">Hashicorp Vault</a>
 and using the Vault - Nomad integration (which I tried and found to be an overkill).</p>
<p>I have chosen the simpler solution of storing them as Nomad Variables. I create them by hand using the Nomad UI, and they are defined 
<a href="https://developer.hashicorp.com/nomad/docs/concepts/variables#task-access-to-variables" target="_blank" rel="noopener">with specific task access</a>
.</p>
<p><img src="/img/wp-content/uploads/2022/12/image.png?w=1024" alt=""></p>
<p>An example set of secrets</p>
<p>These are then injected into the service&rsquo;s container as environment variables using the 
<a href="https://developer.hashicorp.com/nomad/docs/job-specification/template" target="_blank" rel="noopener">template</a>
 block with <code>nomadVar</code>s.</p>
<pre tabindex="0"><code>// Nomad config for getting secrets from Nomad Variables

      template {
        data = &lt;&lt;EOH
{{ with nomadVar &#34;nomad/jobs/owncloud/owncloud/owncloud&#34; }}
OWNCLOUD_DB_NAME={{.db_name}}
OWNCLOUD_DB_USERNAME={{.db_username}}
OWNCLOUD_DB_PASSWORD={{.db_password}}
OWNCLOUD_ADMIN_USERNAME={{.admin_username}}
OWNCLOUD_ADMIN_PASSWORD={{.admin_password}}
{{ end }}

{{ range nomadService &#34;db&#34; }}
OWNCLOUD_DB_HOST={{.Address}}
{{ end }}

{{ range nomadService &#34;redis&#34; }}
OWNCLOUD_REDIS_HOST={{.Address}}
{{ end }}
EOH
        env = true
        destination = &#34;local/env&#34;
      }
</code></pre><h3 id="accessing-private-services">Accessing Private Services</h3>
<p>While this entire project began with trying to self host a 
<a href="http://misskey-hub.net/" target="_blank" rel="noopener">Misskey</a>
 instance as my personal Mastodon alternate, I have started using the setup to run some private services as well - like Node RED, that runs automation like my 
<a href="https://social.arunmozhi.in/notes/9841gtii0v" target="_blank" rel="noopener">RSS-to-ActivityPub bots</a>
.</p>
<p>I don&rsquo;t expose these to the internet, or even the Tailscale network at the moment. They are run on my home local network on a dynamic port assigned to by Nomad. I just access it through the IP:PORT generated by Nomad.</p>
<p><img src="/img/wp-content/uploads/2022/12/image-1.png?w=879" alt=""></p>
<p>Node-RED running at local IP and Dynamic (random) port</p>
<p>I will probably migrate these to the Tailscale Network, if I start traveling and would still want to have access to them. But for now, they are just restricted to my home network.</p>
<h2 id="conclusion">Conclusion</h2>
<p>It has been a wonderful journey figuring all of this out over the last couple of weeks and running the home-server has been a great source of satisfaction . With Docker and Nomad, it has been really easy to try out new services, and set them up quickly.</p>
<p>I woke up on a Sunday and wanted to setup Pihole for blocking ads. I had the house running via Pi-hole in 30 mins. I have found a new kind freedom with this setup. I see this as a small digital balcony garden on the internet.</p>
<p><img src="/img/wp-content/uploads/2022/12/image-2.png?w=1024" alt=""></p>
<h2 id="references">References</h2>
<ol start="2">
<li>
<p>
<a href="https://mrkaran.dev/posts/nomad-networking-explained/" target="_blank" rel="noopener">Understanding Networking in Nomad</a>
 by Karan Sharma</p>
</li>
<li>
<p>
<a href="https://www.youtube.com/watch?v=Egk5L2AM-28" target="_blank" rel="noopener">Translating Docker Compose &amp; Kubernetes to Nomad</a>
 by Luiz Aoqui</p>
</li>
<li>
<p>
<a href="https://www.youtube.com/watch?v=MbAXksROlv4" target="_blank" rel="noopener">Nomad Past Present and Future</a>
 by Luiz Aoqui</p>
</li>
</ol>

        </div>

        
        <nav class="postNav" aria-label="Post navigation">
            
                <a class="postNav-prev postNav-button" href="/2023/04/16/back-to-basics-with-en-kanakku/">
                    <span class="postNav-label"><span aria-hidden="true" class="postNav-arrow">←</span> Newer</span>
                    <span class="postNav-title">Back to Basics with En Kanakku</span>
                </a>
            
            
                <a class="postNav-next postNav-button" href="/2022/11/26/setting-up-my-homeserver-part-2/">
                    <span class="postNav-label">Older <span aria-hidden="true" class="postNav-arrow">→</span></span>
                    <span class="postNav-title">Setting up my HomeServer - Part 2</span>
                </a>
            
        </nav>
        
</div>

            </main>
        </div>


        <footer class="footer">
    
        <span>
            © 2026 Arunmozhi, Built with
            <a href="https://gohugo.io" class="footerLink">Hugo</a> and
            <a href="https://github.com/LordMathis/hugo-theme-nightfall" class="footerLink">Nightfall</a> theme
        </span>
    
</footer>
    </div>

</body>

</html>
