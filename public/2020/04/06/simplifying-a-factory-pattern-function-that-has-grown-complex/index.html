<!DOCTYPE html>
<html lang="en-us">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>
Simplifying a Factory Pattern function that has grown complex | Arunmozhi
</title>

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">

<meta name="generator" content="Hugo 0.154.5">


<link rel="canonical" href="http://localhost:1313/2020/04/06/simplifying-a-factory-pattern-function-that-has-grown-complex/" >




<link href="/css/style.min.66302fa6c122ab7804faa4bd6465554ac4d746c25294af622826d0445b79ab94.css" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
<link rel="stylesheet" href="/css/custom.css">



</head>

<body>

    <div class="flexWrapper">
        <header class="headerWrapper">
    <div class="header">
        <div>
            <a class="terminal" href="/">
                <span>Arunmozhi@arunmozhi.in ~ $</span>
            </a>
        </div>
        <input class="side-menu" type="checkbox" id="side-menu">
        <label class="hamb" for="side-menu"><span class="hamb-line"></span></label>
        <nav class="headerLinks">
            <ul>
                
                <li>
                    <a href="http://localhost:1313/posts/" title="" >
                        ~/blog</a>
                </li>
                
                <li>
                    <a href="http://localhost:1313/about/" title="" >
                        ~/about</a>
                </li>
                
            </ul>
        </nav>
    </div>
</header>


        <div class="content">
            <main class="main">
                
<div class="postWrapper">
        <h1>Simplifying a Factory Pattern function that has grown complex</h1>
        

    
    
    
    

    
    
    
    
    

    
    
    
    
    

    
    
    
    

    
    
    
    

    
    
    
    

    
    <section class="postMetadata">
        <dl>
            
                
<dt>tags</dt>
<dd><span></span>
    <a href="/tags/python/">#Python</a><span></span>
    <a href="/tags/software/">#Software</a></dd>
            
            
            
                
<dt>categories</dt>
<dd><span></span>
    <a href="/categories/coding/">Coding</a></dd>
            
            
                <dt>published</dt>
                 
                 
                 <dd><time datetime="2020-04-06">2020-04-06</time></dd>
            
            
                <dt>reading time</dt>
                <dd>3 minutes</dd>
            
        </dl>
    </section>
    
        <div>
            <blockquote>
<p>This is a combination of the problem that I posted in 
<a href="https://dev.to/tecoholic/what-is-the-right-design-pattern-to-employ-fk6" target="_blank" rel="noopener">Dev.to</a>
 and 
<a href="https://softwareengineering.stackexchange.com/questions/408401/how-to-simplify-a-complex-factory-pattern" target="_blank" rel="noopener">StackExchange</a>
 and the final solution that I adopted.</p>
</blockquote>
<h3 id="the-problem">The Problem</h3>
<p>I have a function which takes the incoming request, parses the data and performs an action and posts the results to a webhook. This is running as background as a Celery Task. This function is a common interface for about a dozen Processors, so can be said to follow the Factory Pattern. Here is the psuedo code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>processors <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;action_1&#34;</span>: ProcessorClass1, 
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;action_2&#34;</span>: ProcessorClass2,
</span></span><span style="display:flex;"><span> <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_task</span>(action, input_file, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Get the input file from a URL</span>
</span></span><span style="display:flex;"><span> log <span style="color:#f92672">=</span> create_logitem()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span> file <span style="color:#f92672">=</span> get_input_file(input_file)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span> log<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Failure&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># process the input file</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span> processor <span style="color:#f92672">=</span> processors[action](file)
</span></span><span style="display:flex;"><span> results <span style="color:#f92672">=</span> processor<span style="color:#f92672">.</span>execute()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span> log<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Failure&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># upload the results to another location</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span> upload_result_file(results<span style="color:#f92672">.</span>file)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span> log<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Failure&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Post the log about the entire process to a webhoook</span>
</span></span><span style="display:flex;"><span> post_results_to_webhook(log)
</span></span></code></pre></div><p>This has been working well for most part as the the inputs were restricted to action and a single argument (<code>input_file</code>). As the software has grown, the processors have increased and the input arguments have started to vary. All the new arguments are passed as keyword arguments and the logic has become more like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span> input_file <span style="color:#f92672">=</span> get_input_file(input_file)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> action <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;action_2&#34;</span>:
</span></span><span style="display:flex;"><span> input_file_2 <span style="color:#f92672">=</span> get_input_file(kwargs<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;input_file_2&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span> log<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;failure&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span> processor <span style="color:#f92672">=</span> processors[action](file)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> action <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;action_1&#34;</span>:
</span></span><span style="display:flex;"><span> extra_argument <span style="color:#f92672">=</span> kwargs<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;extra_argument&#34;</span>)
</span></span><span style="display:flex;"><span> results <span style="color:#f92672">=</span> processor<span style="color:#f92672">.</span>execute(extra_argument)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">elif</span> action <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;action_2&#34;</span>:
</span></span><span style="display:flex;"><span> extra_1 <span style="color:#f92672">=</span> kwargs<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;extra_1&#34;</span>)
</span></span><span style="display:flex;"><span> extra_2 <span style="color:#f92672">=</span> kwargs<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;extra_2&#34;</span>)
</span></span><span style="display:flex;"><span> results <span style="color:#f92672">=</span> processor<span style="color:#f92672">.</span>execute(input_file_2, extra_1, extra_2)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span> results <span style="color:#f92672">=</span> processor<span style="color:#f92672">.</span>execute()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span> log<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Failure&#34;</span>
</span></span></code></pre></div><p>Adding the if conditions for a couple of things didn&rsquo;t make a difference, but now almost 6 of the 11 processors have extra inputs specific to them and the code is starting to look complex and I am not sure how to simplify it. Or if at all I should attempt at simplifying it.</p>
<p>Something I have considered:</p>
<ol>
<li><strong>Create a separate task for the processors with extra inputs</strong> - But this would mean, I will be repeating the file fetching, logging, result upload and webhook code in each task.</li>
<li><strong>Moving the file download and argument parsing into the BaseProcessor</strong> - This is not possible as the processor is used in other contexts without the file download and webhooks as well.</li>
</ol>
<h2 id="the-solution">The solution</h2>
<p>I solved it by making two important changes:</p>
<ol>
<li>Normalised the processor&rsquo;s by making the common arguments positional and everything else keyword based. This allows me to pass the <code>kwargs</code> as I receive them without unpacking. It is the processor&rsquo;s job.</li>
<li>For the extra files, make a copy of the kwargs and replace the remote file url with the local file location. This way, the extra files are a part of the kwargs dict itself.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_task</span>(action, input_file, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> params <span style="color:#f92672">=</span> kwargs<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Get the input file from a URL</span>
</span></span><span style="display:flex;"><span> log <span style="color:#f92672">=</span> create_logitem()
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span> file <span style="color:#f92672">=</span> get_input_file(input_file)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> action <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;action_2&#34;</span>:
</span></span><span style="display:flex;"><span> params[<span style="color:#e6db74">&#34;extra_file&#34;</span>] <span style="color:#f92672">=</span> get_input_file(kwargs[<span style="color:#e6db74">&#34;extra_file&#34;</span>] <span style="color:#75715e"># update the files in params</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span> log<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Failure&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># process the input file</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span> processor <span style="color:#f92672">=</span> processors[action](file)
</span></span><span style="display:flex;"><span> results <span style="color:#f92672">=</span> processor<span style="color:#f92672">.</span>execute(<span style="color:#f92672">**</span>params) <span style="color:#75715e"># Unpack and pass the params</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span> log<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Failure&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># upload the results to another location</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span> upload_result_file(results<span style="color:#f92672">.</span>file)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span> log<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Failure&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#75715e"># Post the log about the entire process to a webhoook</span>
</span></span><span style="display:flex;"><span> post_results_to_webhook(log)
</span></span></code></pre></div><p>Now I have the same lean structure as I originally had. The only processor specific code is the file downloads which I think I can live with for now.</p>
<h3 id="credits">Credits</h3>
<p>
<a href="https://softwareengineering.stackexchange.com/users/319783/kain0-0" target="_blank" rel="noopener">Kain0_0</a>
&rsquo;s answer pointed me in the right direction and helped me simplify it in a way that makes sense.</p>

        </div>

        
        <nav class="postNav" aria-label="Post navigation">
            
                <a class="postNav-prev postNav-button" href="/2020/04/07/building-a-quick-and-dirty-data-collection-app-with-react-google-sheets-and-aws-s3/">
                    <span class="postNav-label"><span aria-hidden="true" class="postNav-arrow">←</span> Newer</span>
                    <span class="postNav-title">Building a quick and dirty data collection app with React, Google Sheets and AWS S3</span>
                </a>
            
            
                <a class="postNav-next postNav-button" href="/2020/03/11/employing-vuejs-reactivity-to-update-d3-js-visualisations-part-2/">
                    <span class="postNav-label">Older <span aria-hidden="true" class="postNav-arrow">→</span></span>
                    <span class="postNav-title">Employing VueJS reactivity to update D3.js Visualisations – Part 2</span>
                </a>
            
        </nav>
        
</div>

            </main>
        </div>


        <footer class="footer">
    
        <span>
            © 2026 Arunmozhi, Built with
            <a href="https://gohugo.io" class="footerLink">Hugo</a> and
            <a href="https://github.com/LordMathis/hugo-theme-nightfall" class="footerLink">Nightfall</a> theme
        </span>
    
</footer>
    </div>

</body>

</html>
